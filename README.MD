# BE_THEP_DONG_ANH

## Project Architecture

D·ª± √°n n√†y cung c·∫•p m·ªôt **h·ªá th·ªëng backend** s·ª≠ d·ª•ng **ExpressJS** v√† **Prisma ORM**. N√≥ ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ **t√°ch bi·ªát x·ª≠ l√Ω logic** gi·ªØa c√°c th√†nh ph·∫ßn kh√°c nhau trong h·ªá th·ªëng (**API, worker, socket, message queue, v.v.**) nh·∫±m ƒë·∫£m b·∫£o **t√≠nh module v√† d·ªÖ b·∫£o tr√¨**.

---

### üèó Architectural Separation

- **API**: X·ª≠ l√Ω logic API v√† tr·∫£ v·ªÅ ph·∫£n h·ªìi cho ng∆∞·ªùi d√πng.
- **Worker**: X·ª≠ l√Ω c√°c t√°c v·ª• n·ªÅn v√† t√≠nh to√°n n·∫∑ng.
- **Th√†nh ph·∫ßn kh√°c**: C√°c th√†nh ph·∫ßn b·ªï sung nh∆∞ socket, message queue, v.v., ƒë∆∞·ª£c qu·∫£n l√Ω ri√™ng bi·ªát.
- **Common**: X·ª≠ l√Ω c√°c t√°c v·ª• chung c·ªßa c√°c th√†nh ph·∫ßn kh√°c (bussiness logic, adapter,... v√† nh·ªØng t√†i nguy√™n d√πng ƒë·ªÉ ph·ª•c v·ª• ch√≠nh trong `common`).
- **Config**: Ch·ª©a c√°c th√†nh ph·∫ßn khai b√°o const c·ªßa c√°c ƒë·ªëi t∆∞·ª£ng v√† data fix c·ª©ng trong h·ªá th·ªëng.
- **Event v√† Job** S·∫Ω ƒë∆∞·ª£c khai b√°o v√† ƒëƒÉng k√Ω v√† khai b√°o th√¥ng qua c√°c th√†nh ph·∫ßn li√™n quan.
---

### ‚öôÔ∏è Business Logic Handling

To√†n b·ªô logic nghi·ªáp v·ª• ƒë∆∞·ª£c x·ª≠ l√Ω trong th∆∞ m·ª•c `common` v√† `services` b√™n trong `common`, **tr√°nh ph·ª• thu·ªôc ch√©o** gi·ªØa c√°c th√†nh ph·∫ßn kh√°c nhau trong h·ªá th·ªëng.

---

### üõ† Modular Design Approach

D·ª± √°n n√†y tu√¢n theo **c√°ch ti·∫øp c·∫≠n l·∫≠p tr√¨nh theo module**, trong ƒë√≥ **entity** ƒë∆∞·ª£c qu·∫£n l√Ω v√† x·ª≠ l√Ω trong m·ªôt module ri√™ng bi·ªát, ƒë·∫£m b·∫£o **t√≠nh m·ªü r·ªông v√† d·ªÖ b·∫£o tr√¨**.
VD: module c·ªßa ƒë·ªëi t∆∞·ª£ng `auth` ch·ªâ x·ª≠ l√Ω li√™n quan ƒë·∫øn API s·∫Ω quy v√†o c√πng m·ªôt folder auth **(route, controller, validator)**, c√°c logic li√™n quan ƒë·∫øn x·ª≠ l√Ω chung gi·ªØa c√°c th√†nh ph·∫ßn c≈©ng s·∫Ω quy v·ªÅ m·ªôt folder `auth` trong common **(service, event)**

---

### üí¨ Message Language
C√°c message ƒë∆∞·ª£c tr·∫£ v·ªÅ s·∫Ω ƒë∆∞·ª£c d·ªãch t·ª± ƒë·ªông qua 2 ng√¥n ng·ªØ l√† Anh v√† Vi·ªát theo request c·ªßa user theo config trong i18.middleware v√† response.middleware. VD: m√°y client c√≥ ng√¥n ng·ªØ l√† ti·∫øng Vi·ªát th√¨ message t·ª´ m·ªói response s·∫Ω tr·∫£ v·ªÅ ti·∫øng Vi·ªát v√† ng∆∞·ª£c l·∫°i.

---

### üéØ Object-Oriented Configuration with EventEmitter

ƒê·ªÉ ƒë·∫£m b·∫£o kh·∫£ nƒÉng **t√°i s·ª≠ d·ª•ng v√† b·∫£o tr√¨** c√°c **t√°c v·ª• ph·ª• (side effects)**, d·ª± √°n n√†y s·ª≠ d·ª•ng **l·∫≠p tr√¨nh h∆∞·ªõng s·ª± ki·ªán** v·ªõi Node.js 
[`EventEmitter`](https://nodejs.org/api/events.html).
[`Link tham kh·∫£o`](https://viblo.asia/p/event-driven-programming-va-cau-chuyen-nguoi-dua-thu-1VgZvA8YKAw)
D·ªÖ d√†ng tri·ªÉn khai tri·∫øn l∆∞·ª£c multiple entrypoint khi c·∫ßn scale h·ªá th·ªëng. ƒê·ªëi v·ªõi c√°c h·ªá th·ªëng t·∫£i l·ªõn c√≥ kh·∫£ nƒÉng m·ªü r·ªông CPU v·ªõi nhi·ªÅu core v√† ƒëa lu·ªìng c√≥ th·ªÉ x·ª≠ l√Ω t√°ch c√°c t√°c v·ª• ra th√†nh c√°c entrypoint ƒë·ªÉ qu·∫£n l√Ω c√°c process ra ri√™ng bi·ªát v√† t·∫≠n d·ª•ng ƒë∆∞·ª£c kh·∫£ nƒÉng ƒëa lu·ªìng c·ªßa CPU.
[`Link tham kh·∫£o`](https://viblo.asia/p/api-nodejs-cua-toi-da-handle-peak-traffic-nhu-the-nao-x7Z4D6mPLnX)

#### üîπ Why use EventEmitter?
- **T√°ch bi·ªát logic**: Logic nghi·ªáp v·ª• v√† c√°c t√°c v·ª• ph·ª• (ghi log, th√¥ng b√°o, c·∫≠p nh·∫≠t cache,... ) ƒë∆∞·ª£c x·ª≠ l√Ω ri√™ng bi·ªát.
- **T√°i s·ª≠ d·ª•ng t·ªët h∆°n**: Nhi·ªÅu module c√≥ th·ªÉ l·∫Øng nghe c√πng m·ªôt s·ª± ki·ªán m√† kh√¥ng c·∫ßn ch·ªânh s·ª≠a logic c·ªët l√µi.
- **D·ªÖ m·ªü r·ªông**: C√≥ th·ªÉ th√™m c√°c b·ªô x·ª≠ l√Ω s·ª± ki·ªán m·ªõi m√† kh√¥ng c·∫ßn thay ƒë·ªïi m√£ ngu·ªìn hi·ªán c√≥.
- **C·∫£i thi·ªán t·ªëc ƒë·ªô ph·∫£n h·ªìi sau m·ªói request**: C√°c side effect ƒë∆∞·ª£c t√°ch bi·ªát v√† x·ª≠ l√Ω b·∫•t ƒë·ªìng b·ªô s·∫Ω l√†m gi·∫£m th·ªùi gian ph·∫£n h·ªìi c·ªßa app

---

## COMMAND

### Application
- `yarn dev` Ch·∫°y d·ª± √°n v·ªõi m√¥i tr∆∞·ªùng dev
- `yarn build` Build project v√†o th∆∞ m·ª•c dist. Th∆∞·ªùng s·∫Ω ch·∫°y build tr∆∞·ªõc khi ƒë·∫©y l√™n main ƒë·ªÉ ƒë·∫£m b·∫£o build tr√™n github action kh√¥ng x·∫£y ra l·ªói
- `yarn format` Format to√†n b·ªô source trong d·ª± √°n
- `yarn clean` T∆∞∆°ng t·ª± nh∆∞ c√¢u l·ªánh `rm -rf` tr√™n Unix/Linux d√πng ƒë·ªÉ clean d·ªØ li·ªáu trong th∆∞ m·ª•c dist
- `yarn start` Ch·∫°y ·ª©ng d·ª•ng trong th∆∞ m·ª•c dist (production)

### Prisma
- `yarn prisma:push` ƒê·ªÉ ƒë·ªìng b·ªô schema v·ªõi database hi·ªán t·∫°i sau khi thay ƒë·ªïi v·ªÅ db
- `yarn prisma:gen` Generate schema
- `yarn prisma:mig` T·∫°o v√†o √°p d·ª•ng migration
- `yarn prisma:seed` ƒê·ªÉ kh·ªüi t·∫°o d·ªØ li·ªáu m·∫´u t·ª´ file seed.ts
- `yarn prisma:reset` ƒê·ªÉ x√≥a to√†n b·ªô d·ªØ li·ªáu trong database

---

## APP
### Lu·ªìng thi·∫øt b·ªã ƒëƒÉng nh·∫≠p
- User khi ƒëƒÉng nh·∫≠p t·ª´ client s·∫Ω g·ª≠i l√™n m·ªôt device_id, h·ªá th·ªëng s·∫Ω ki·ªÉm tra device_id ƒë√≥ ƒë·ªÉ x√°c ƒë·ªãnh thi·∫øt b·ªã ƒëƒÉng nh·∫≠p c·ªßa user
+ N·∫øu device_id = null => l·ªói client tr·∫£ v·ªÅ th√¥ng b√°o l·ªói
+ N·∫øu device_id kh√¥ng kh·ªõp trong h·ªá th·ªëng (thi·∫øt b·ªã m·ªõi) -> H·ªá th·ªëng g·ª≠i th√¥ng b√°o ch·ªù v·ªÅ mail cho user (mail trong b·∫£ng `employee`)
-> t·∫°o m·ªôt b·∫£n ghi v√†o `device_request` ch·ªù qu·∫£n tr·ªã vi√™n duy·ªát. N·∫øu qu·∫£n tr·ªã vi√™n ch·∫•p nh·∫≠n, ƒëƒÉng xu·∫•t t·∫•t c·∫£ c√°c thi·∫øt b·ªã ƒëang truy c·∫≠p v√†o t√†i kho·∫£n ƒë√≥ v√† c·∫≠p nh·∫≠t l·∫°i device_id cho user sau ƒë√≥ g·ª≠i l·∫°i m·ªôt mail cho user ƒë·ªÉ x√°c nh·∫≠n. T·ª´ ch·ªëi c≈©ng s·∫Ω g·ª≠i m·ªôt mail t·ª´ ch·ªëi v·ªÅ
+ N·∫øu device_id kh·ªõp v·ªõi device_id trong user => pass
+ N·∫øu accept thi·∫øt b·ªã m·ªõi -> logout t·∫•t c·∫£ c√°c thi·∫øt b·ªã c≈© (revoke tokens)

### Token
- S·ª≠ d·ª•ng device_id ƒë·ªÉ l√†m secret cho token

### Truy v·∫•n v·ªõi prisma
- S·ª≠ d·ª•ng layout repo ƒë·ªÉ truy v·∫•n t·∫≠p trung v√† t∆∞∆°ng t√°c v·ªõi database, c√°c repo s·∫Ω ƒë∆∞·ª£c k·∫ø th·ª´a t·ª´ base repo. H√£y tham kh·∫£o c√°c ƒëo·∫°n code s·ª≠ d·ª•ng layout extend t·ª´ base repo ƒë·ªÉ th·ª±c hi·ªán truy v·∫•n v·ªõi db m√† kh√¥ng c·∫ßn config th√™m c√°c logic truy v·∫•n
- S·ª± t√°ch bi·ªát logic truy v·∫•n v·ªõi logic c·ªßa app ƒë·ªÉ l√†m r√µ c√°c t√≠nh to√°n tr√™n t·∫ßng service, gi·ªØ cho t·∫ßng service ch·ªâ ƒë·ªÉ ph·ª•c v·ª• c√°c bussiness logic li√™n quan t·ªõi lu·ªìng ch√≠nh c·ªßa app v√† x·ª≠ l√Ω b·∫Øt l·ªói.

## L∆∞u √Ω:
### validator layout ·∫£nh h∆∞·ªüng t·ªõi input data truy·ªÅn l√™n
- M·ªçi request th·ª´a khi truy·ªÅn l√™n s·∫Ω b·ªã l·ªçc h·∫øt ·ªü t·∫ßng validate n·∫øu kh√¥ng ƒë∆∞·ª£c khai b√°o trong validate. ƒë·ªÉ ƒë·∫£m b·∫£o input kh√¥ng b·ªã th·ª´a nhi·ªÅu n√™n c·∫ßn l∆∞u √Ω n·∫øu c√≥ tr∆∞·ªùng n√†o c·∫ßn s·ª≠ d·ª•ng t·ª´ client truy·ªÅn l√™n th√¨ ph·∫£i khai b√°o trong validate v√† ƒë·ªÉ optional - allow empty ƒë·ªÉ kh√¥ng b·ªã required.

```ts
import Joi from 'joi';

export const wrapSchema = (schema: Joi.ObjectSchema): Joi.ObjectSchema =>
    schema.options({
        abortEarly: false,
        allowUnknown: true,
        stripUnknown: true,
    });
```

- Khai b√°o m·∫´u:
```ts
import { wrapSchema } from '@common/helpers/wrap-schema.helper';
import { OrganizationType } from '@config/app.constant';
import { Joi, schema } from 'express-validation';
import { values } from 'lodash';

export const create: schema = {
    body: wrapSchema(
        Joi.object({
            name: Joi.string().required().min(1).max(300),
            code: Joi.string().required().min(1).max(100),
            responsibility: Joi.string().optional().allow(null, '').min(1).max(100),
            file: Joi.object().optional().allow(null, ''),
            type: Joi.string()
                .required()
                .valid(...values([OrganizationType.COMPANY, OrganizationType.DEPARTMENT])),
            parent_id: Joi.number().required(),
            leader_id: Joi.number().allow(null, ''),
        }),
    ),
};

export const update: schema = {
    params: wrapSchema(
        Joi.object({
            id: Joi.number().required(),
        }),
    ),
    body: wrapSchema(
        Joi.object({
            name: Joi.string().required().min(1).max(300),
            code: Joi.string().required().min(1).max(100),
            responsibility: Joi.string().optional().allow(null, '').min(1).max(100),
            file: Joi.object().optional().allow(null, ''),
            type: Joi.string()
                .required()
                .valid(...values([OrganizationType.COMPANY, OrganizationType.DEPARTMENT])),
            parent_id: Joi.number().required(),
            leader_id: Joi.number().required(),
        }),
    ),
};
```

- V·ªõi format time input s·∫Ω c√≥ ƒë·ªãnh d·∫°ng chung l√† YYYY-MM-DD ·ªü d·∫°ng string, nh·ªØng ƒë·ªëi t∆∞·ª£ng th·ªùi gian n√†y s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông truy·ªÉn th√†nh iso timestamp UTC+0  ·ªü layer validate. VD:
```ts
invoice_date: Joi.string().isoDate().optional().allow(null),
```
--- Con th∆∞ vi·ªán t·ª´ ƒë·ªùi Napoleon n√†y c≈©ng pro ph·∫øt =))

## DOCUMENTS
[`Document link`](https://drive.google.com/drive/folders/1YTbmTn_Sus2NhwOx1hN9RDytSQiwCWR8)