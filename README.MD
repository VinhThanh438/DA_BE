# BE_DA

## Project Architecture

Dá»± Ã¡n nÃ y cung cáº¥p má»™t **há»‡ thá»‘ng backend** sá»­ dá»¥ng **ExpressJS** vÃ  **Prisma ORM**. NÃ³ Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ **tÃ¡ch biá»‡t xá»­ lÃ½ logic** giá»¯a cÃ¡c thÃ nh pháº§n khÃ¡c nhau trong há»‡ thá»‘ng (**API, worker, socket, message queue, v.v.**) nháº±m Ä‘áº£m báº£o **tÃ­nh module vÃ  dá»… báº£o trÃ¬**.

---

### ðŸ— Architectural Separation

- **API**: Xá»­ lÃ½ logic API vÃ  tráº£ vá» pháº£n há»“i cho ngÆ°á»i dÃ¹ng.
- **Worker**: Xá»­ lÃ½ cÃ¡c tÃ¡c vá»¥ ná»n vÃ  tÃ­nh toÃ¡n náº·ng.
- **ThÃ nh pháº§n khÃ¡c**: CÃ¡c thÃ nh pháº§n bá»• sung nhÆ° socket, message queue, v.v., Ä‘Æ°á»£c quáº£n lÃ½ riÃªng biá»‡t.
- **Common**: Xá»­ lÃ½ cÃ¡c tÃ¡c vá»¥ chung cá»§a cÃ¡c thÃ nh pháº§n khÃ¡c (bussiness logic, adapter,... vÃ  nhá»¯ng tÃ i nguyÃªn dÃ¹ng Ä‘á»ƒ phá»¥c vá»¥ chÃ­nh trong `common`).
- **Config**: Chá»©a cÃ¡c thÃ nh pháº§n khai bÃ¡o const cá»§a cÃ¡c Ä‘á»‘i tÆ°á»£ng vÃ  data fix cá»©ng trong há»‡ thá»‘ng.
- **Event vÃ  Job** Sáº½ Ä‘Æ°á»£c khai bÃ¡o vÃ  Ä‘Äƒng kÃ½ vÃ  khai bÃ¡o thÃ´ng qua cÃ¡c thÃ nh pháº§n liÃªn quan.
---

### âš™ï¸ Business Logic Handling

ToÃ n bá»™ logic nghiá»‡p vá»¥ Ä‘Æ°á»£c xá»­ lÃ½ trong thÆ° má»¥c `common` vÃ  `services` bÃªn trong `common`, **trÃ¡nh phá»¥ thuá»™c chÃ©o** giá»¯a cÃ¡c thÃ nh pháº§n khÃ¡c nhau trong há»‡ thá»‘ng.

---

### ðŸ›  Modular Design Approach

Dá»± Ã¡n nÃ y tuÃ¢n theo **cÃ¡ch tiáº¿p cáº­n láº­p trÃ¬nh theo module**, trong Ä‘Ã³ **entity** Ä‘Æ°á»£c quáº£n lÃ½ vÃ  xá»­ lÃ½ trong má»™t module riÃªng biá»‡t, Ä‘áº£m báº£o **tÃ­nh má»Ÿ rá»™ng vÃ  dá»… báº£o trÃ¬**.
VD: module cá»§a Ä‘á»‘i tÆ°á»£ng `auth` chá»‰ xá»­ lÃ½ liÃªn quan Ä‘áº¿n API sáº½ quy vÃ o cÃ¹ng má»™t folder auth **(route, controller, validator)**, cÃ¡c logic liÃªn quan Ä‘áº¿n xá»­ lÃ½ chung giá»¯a cÃ¡c thÃ nh pháº§n cÅ©ng sáº½ quy vá» má»™t folder `auth` trong common **(service, event)**

---

### ðŸ’¬ Message Language
CÃ¡c message Ä‘Æ°á»£c tráº£ vá» sáº½ Ä‘Æ°á»£c dá»‹ch tá»± Ä‘á»™ng qua 2 ngÃ´n ngá»¯ lÃ  Anh vÃ  Viá»‡t theo request cá»§a user theo config trong i18.middleware vÃ  response.middleware. VD: mÃ¡y client cÃ³ ngÃ´n ngá»¯ lÃ  tiáº¿ng Viá»‡t thÃ¬ message tá»« má»—i response sáº½ tráº£ vá» tiáº¿ng Viá»‡t vÃ  ngÆ°á»£c láº¡i.

---

### ðŸŽ¯ Object-Oriented Configuration with EventEmitter

Äá»ƒ Ä‘áº£m báº£o kháº£ nÄƒng **tÃ¡i sá»­ dá»¥ng vÃ  báº£o trÃ¬** cÃ¡c **tÃ¡c vá»¥ phá»¥ (side effects)**, dá»± Ã¡n nÃ y sá»­ dá»¥ng **láº­p trÃ¬nh hÆ°á»›ng sá»± kiá»‡n** vá»›i Node.js 
[`EventEmitter`](https://nodejs.org/api/events.html).
[`Link tham kháº£o`](https://viblo.asia/p/event-driven-programming-va-cau-chuyen-nguoi-dua-thu-1VgZvA8YKAw)
Dá»… dÃ ng triá»ƒn khai triáº¿n lÆ°á»£c multiple entrypoint khi cáº§n scale há»‡ thá»‘ng. Äá»‘i vá»›i cÃ¡c há»‡ thá»‘ng táº£i lá»›n cÃ³ kháº£ nÄƒng má»Ÿ rá»™ng CPU vá»›i nhiá»u core vÃ  Ä‘a luá»“ng cÃ³ thá»ƒ xá»­ lÃ½ tÃ¡ch cÃ¡c tÃ¡c vá»¥ ra thÃ nh cÃ¡c entrypoint Ä‘á»ƒ quáº£n lÃ½ cÃ¡c process ra riÃªng biá»‡t vÃ  táº­n dá»¥ng Ä‘Æ°á»£c kháº£ nÄƒng Ä‘a luá»“ng cá»§a CPU.
[`Link tham kháº£o`](https://viblo.asia/p/api-nodejs-cua-toi-da-handle-peak-traffic-nhu-the-nao-x7Z4D6mPLnX)

#### ðŸ”¹ Why use EventEmitter?
- **TÃ¡ch biá»‡t logic**: Logic nghiá»‡p vá»¥ vÃ  cÃ¡c tÃ¡c vá»¥ phá»¥ (ghi log, thÃ´ng bÃ¡o, cáº­p nháº­t cache,... ) Ä‘Æ°á»£c xá»­ lÃ½ riÃªng biá»‡t.
- **TÃ¡i sá»­ dá»¥ng tá»‘t hÆ¡n**: Nhiá»u module cÃ³ thá»ƒ láº¯ng nghe cÃ¹ng má»™t sá»± kiá»‡n mÃ  khÃ´ng cáº§n chá»‰nh sá»­a logic cá»‘t lÃµi.
- **Dá»… má»Ÿ rá»™ng**: CÃ³ thá»ƒ thÃªm cÃ¡c bá»™ xá»­ lÃ½ sá»± kiá»‡n má»›i mÃ  khÃ´ng cáº§n thay Ä‘á»•i mÃ£ nguá»“n hiá»‡n cÃ³.
- **Cáº£i thiá»‡n tá»‘c Ä‘á»™ pháº£n há»“i sau má»—i request**: CÃ¡c side effect Ä‘Æ°á»£c tÃ¡ch biá»‡t vÃ  xá»­ lÃ½ báº¥t Ä‘á»“ng bá»™ sáº½ lÃ m giáº£m thá»i gian pháº£n há»“i cá»§a app

---

## COMMAND

### Application
- `yarn dev` Cháº¡y dá»± Ã¡n vá»›i mÃ´i trÆ°á»ng dev
- `yarn build` Build project vÃ o thÆ° má»¥c dist. ThÆ°á»ng sáº½ cháº¡y build trÆ°á»›c khi Ä‘áº©y lÃªn main Ä‘á»ƒ Ä‘áº£m báº£o build trÃªn github action khÃ´ng xáº£y ra lá»—i
- `yarn format` Format toÃ n bá»™ source trong dá»± Ã¡n
- `yarn clean` TÆ°Æ¡ng tá»± nhÆ° cÃ¢u lá»‡nh `rm -rf` trÃªn Unix/Linux dÃ¹ng Ä‘á»ƒ clean dá»¯ liá»‡u trong thÆ° má»¥c dist
- `yarn start` Cháº¡y á»©ng dá»¥ng trong thÆ° má»¥c dist (production)

### Prisma
- `yarn prisma:push` Äá»ƒ Ä‘á»“ng bá»™ schema vá»›i database hiá»‡n táº¡i sau khi thay Ä‘á»•i vá» db
- `yarn prisma:gen` Generate schema
- `yarn prisma:mig` Táº¡o vÃ o Ã¡p dá»¥ng migration
- `yarn prisma:seed` Äá»ƒ khá»Ÿi táº¡o dá»¯ liá»‡u máº«u tá»« file seed.ts
- `yarn prisma:reset` Äá»ƒ xÃ³a toÃ n bá»™ dá»¯ liá»‡u trong database

---

## APP
### Luá»“ng thiáº¿t bá»‹ Ä‘Äƒng nháº­p
- User khi Ä‘Äƒng nháº­p tá»« client sáº½ gá»­i lÃªn má»™t device_id, há»‡ thá»‘ng sáº½ kiá»ƒm tra device_id Ä‘Ã³ Ä‘á»ƒ xÃ¡c Ä‘á»‹nh thiáº¿t bá»‹ Ä‘Äƒng nháº­p cá»§a user
+ Náº¿u device_id = null => lá»—i client tráº£ vá» thÃ´ng bÃ¡o lá»—i
+ Náº¿u device_id khÃ´ng khá»›p trong há»‡ thá»‘ng (thiáº¿t bá»‹ má»›i) -> Há»‡ thá»‘ng gá»­i thÃ´ng bÃ¡o chá» vá» mail cho user (mail trong báº£ng `employee`)
-> táº¡o má»™t báº£n ghi vÃ o `device_request` chá» quáº£n trá»‹ viÃªn duyá»‡t. Náº¿u quáº£n trá»‹ viÃªn cháº¥p nháº­n, Ä‘Äƒng xuáº¥t táº¥t cáº£ cÃ¡c thiáº¿t bá»‹ Ä‘ang truy cáº­p vÃ o tÃ i khoáº£n Ä‘Ã³ vÃ  cáº­p nháº­t láº¡i device_id cho user sau Ä‘Ã³ gá»­i láº¡i má»™t mail cho user Ä‘á»ƒ xÃ¡c nháº­n. Tá»« chá»‘i cÅ©ng sáº½ gá»­i má»™t mail tá»« chá»‘i vá»
+ Náº¿u device_id khá»›p vá»›i device_id trong user => pass

### Token
- Sá»­ dá»¥ng device_id Ä‘á»ƒ lÃ m secret cho token